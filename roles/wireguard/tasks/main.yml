---
# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/blockinfile_module.html

# - name: Reduce mtu
#   ansible.builtin.import_tasks: reduce_mtu.yml
# - name: Installed
#   ansible.builtin.import_tasks: installed.yml

- name: Facts, delete, add, new server
  ansible.builtin.import_tasks: facts.yml

- name: Facts, building blocks
  ansible.builtin.set_fact:
    wg_part_server: "{{ wireguard_parts_path }}/1_server_{{ wireguard_interface }}.conf"
    wg_part_existing: "{{ wireguard_parts_path }}/2_client_{{ wireguard_interface }}.conf"
    wg_part_new: "{{ wireguard_parts_path }}/3_client_{{ wireguard_interface }}.conf"

- name: Block server
  block:
    - name: Folders
      ansible.builtin.import_tasks: folders.yml

    - name: New wg server
      ansible.builtin.import_tasks: make_new_server.yml
      when: wg_new_server

    # Extract server block, extract clients to keep block
    - name: Existing wg server
      ansible.builtin.import_tasks: make_existing_server.yml
      when: not wg_new_server and (wg_clients_to_delete or wg_clients_to_add)
  when: wg_new_server or wg_clients_to_delete or wg_clients_to_add

- name: Block clients, existing and new
  block:
    - name: Add starting ansible blockinfile marker for peers
      ansible.builtin.lineinfile:
        dest: "{{ wg_part_server }}"
        line: "# vps_peers ANSIBLE MANAGED BLOCK"
        state: present

    - name: Keep existing clients
      ansible.builtin.import_tasks: make_existing_clients.yml
      when: not wg_new_server

    - name: Make new clients
      ansible.builtin.import_tasks: make_new_clients.yml
      vars:
        client_index_start: "{{ wg_clients_from_server | default([]) | length + 1 }}"
      when: wg_clients_to_add
  when: wg_new_server or wg_clients_to_delete or wg_clients_to_add

- name: Block endresult
  block:
    - name: Assemble all parts
      ansible.builtin.import_tasks: make_config_result.yml
      notify: Remove server parts

    - name: Add closing ansible blockinfile marker for peers
      ansible.builtin.lineinfile:
        dest: "{{ wireguard_server_conf }}"
        line: "# vps_peers END ANSIBLE MANAGED BLOCK"
        state: present
  when: wg_new_server or wg_clients_to_delete or wg_clients_to_add

# - name: Ensure WireGuard enabled and started
#   ansible.builtin.systemd:
#     name: "{{ wireguard_service_name }}"
#     state: started
#     enabled: true
